# oauth2 自定流程
地微WEB平台授权、地微移动端授权、三方（网页或移动端）接入授权统一规范
## 一、关键地址

* /oauth/authorize:      专用于授权码模式。两个功能：
> 1、发放授权码（需先登录）；  
> 2、检测是否需要用户授权并重定向到授权页然后处理用户向其提交的授权页确认结果。  
> 注意：申请授权码的客户端如果开启了用户授权确认，oauth2会发起重定向请求/oauth/confirm_access，因此可拦截此请求返回协议形式，让客户端自定用户确认页面  
* /oauth/token:          获取token
>（无论是通过授权码或自定义授权模式都要调此接口以换取或获取令牌）  
* /oauth/confirm_access: 用户授权页
> 会由auth2自动向客户端发起重定向到此页，认证服务器可拦截此请求重定向到自定义的用户授权页
* /oauth/error:          认证失败
* /oauth/check_token:    资源服务器用来校验token
* /oauth/token_key:      如果jwt模式则可以用此来从认证服务器获取公钥

## 二、流程概要
- 用户通过网关向后台geochat-app（oauth2类型的微服务）发起请求，判断令牌是否合法
- 如果不合法则协议告知客户端需登录（响应中应包含登录地址。根据客户端是否web或移动端，是否是第三方web或第三方移动端）
- 客户端登录： 
> 1、如果是Web平台则由客户端重定向到认证中心的登录页  
> 2、如果是移动端则由客户端调起移动端登录页（如果是客户端是第三方的移动端，
> 则根据android或ios的跨app调起规范uri唤起地微app登录，如果是地微app本身的登录，则跳转到登录页)  
> 3、登录后协议告知客户端认证结果  
> 4、如果认证成功，则由客户端根据授权类型向认证服务器发起相应的请求，包括：  
> 4.1、如果是授权码模式，则向/oauth/authorize地址发起请求。
> 4.1.1 如果客户端配置的不需要用户授权确认，
> 则该次请求会由oauth2根据客户端配置的redirect_uri重定向到redirect_uri并在地址附上code值。  
> 4.1.2 如果客户端需要用户授权确认，则该次请求会由oauth2发起重定向到/oauth/confirm_access，
> 服务器端可拦截此请求协议告知客户端用户授权确认的地址，由客户端来跳转到对应的地微平台自定义的用户授权页地址，
> 不在服务器上直接重定向到目标地址是因为，移动端和web端的用户授权页面的跳转规则不同，一样存在
> web或移动端，是否是第三方web或第三方移动端。  
> 4.1.3 自定义的授权页由用户提交到/oauth/authorize，提交后oauth2会向客户端发起重定向到客户端的redirect_uri并附上code值  
> 4.2 如果是非授权码模式，则可直接向/oauth/token获取令牌，并协议告知客户端令牌  
> 4.3 如果已得到授权码，则可向/oauth/token换取令牌，并协议告知客户端令牌  
## 注意事项
- 客户端发起请求实际上是指通过像web的ajax、dart的dio、java的httpclient等工具，这些工具均会持有jsessionid，因此只要登录过，则其内任何向/oauth/authorize索要授权码的请求，都不会被重定向到登录，除非这些工具不是同一实例或没有附上jsessionid或会话过期
- 短信验证码、租户认证、邮箱验证码等自定义的认证模式，在登录之后也可像授权码认证模式一样通过向/oauth/authorize提交请求以获取验证码，以此来使用用户授权确认页，不必非得直接向/oauth/token获取令牌。
- 保留对租户认证方式的支持，并让geochat-app支持两种AppAuthentication（对应两种DefaultAppPrincipal），一种是默认的不含租户，一种是租户应用验证器